<?php
/** @noinspection ALL */
/**
  * @author      Be Rebel - https://berebel.io
  * @copyright   ©2023 Stock Management Labs™
 */
 namespace Atum\Addons; defined('ABSPATH') || die; use Atum\Components\AtumAdminNotices; use Atum\Components\AtumAdminModal; use Atum\Inc\Helpers; final class AddonsLoader { private $d__e2 = array('action_logs' => '1.1.5', 'export_pro' => '1.3.4', 'multi_inventory' => '1.5.0', 'product_levels' => '1.6.0', 'purchase_orders' => '0.0.1', 'stock_takes' => '0.0.1', 'pick_pack' => '0.0.1'); private $hkb5Q = array('action_logs' => '1.3.5', 'export_pro' => '1.5.5', 'multi_inventory' => '1.8.0', 'product_levels' => '1.8.7.1', 'purchase_orders' => '1.1.1', 'stock_takes' => '1.0.0', 'pick_pack' => '1.0.0'); private static $DJCAe = []; private static $n7E4f = []; private $B_wWp; public function __construct() { goto lCvKl; n6nuU: add_action('after_setup_theme', array($this, 'load_addons'), 99); goto KGehr; zTuvK: $rYttU = (array) apply_filters('atum/addons/loader/extra_addons', []); goto iNx3c; lCvKl: $this->B_wWp = defined('ATUM_DEBUG') && TRUE === ATUM_DEBUG; goto zTuvK; KGehr: $this->check_trials(); goto vIgM9; C2Z2i: foreach ($rYttU as $LEdLv => $veEfZ) { goto skn6X; skn6X: if (!(!array_key_exists($LEdLv, $this->hkb5Q) && version_compare($veEfZ, '0.0', '>'))) { goto ZaiF4; } goto b2MtW; HXhCm: XUP2y: goto JuQrw; Gzn_O: ZaiF4: goto HXhCm; b2MtW: $this->hkb5Q[$LEdLv] = $veEfZ; goto Gzn_O; JuQrw: } goto aJ3dA; iNx3c: if (empty($rYttU)) { goto jAlXM; } goto C2Z2i; bgKMT: jAlXM: goto n6nuU; aJ3dA: eSGgU: goto bgKMT; vIgM9: } public function load_addons() { goto BVeFL; wZ1_9: foreach ($j2NLR as $ARj1j => $Pd50I) { goto sh7gf; zPfXR: $dJ5t3 = sprintf(__('The ATUM %s could not be loaded because the full version is installed. To use the trial, uninstall the full version first.', ATUM_TEXT_DOMAIN), $Pd50I['name']); goto pUOWf; xPncZ: goto KSvZV; goto k2BTJ; Jtr_z: if (!$anzkV) { goto ujyRB; } goto TXvYE; fZnru: Bzgrr: goto sTNV_; eThyq: $j2NLR[$ARj1j]['bootstrap'] = NULL; goto FMqef; wp0DV: goto KSvZV; goto fZnru; JITM_: MguQ2: goto UavsK; Vpipg: $j2NLR[$ARj1j]['bootstrap'] = NULL; goto JHsRP; rCdRL: goto IMKXc; goto JL6vO; FQrDn: self::$n7E4f[] = $ARj1j; goto wp0DV; clcap: $MXkXw[$ARj1j] = $Pd50I; goto R12j7; sTNV_: if (!version_compare($this->hkb5Q[$U6Ff1], $Pd50I['version'], '>')) { goto vnYbF; } goto HVcMF; A4Fxw: $MXkXw[$ARj1j]['key'] = $DyFgM[$t88Br]['key']; goto KRbJL; NYmZy: AtumAdminNotices::add_notice($dJ5t3, strtolower($Pd50I['name']), 'error', FALSE, TRUE); goto yr1Ts; KCgiY: KSvZV: goto qVTty; wk19h: $dJ5t3 = sprintf(__('Your ATUM %1$s has expired on %2$s, and it has been disabled.', ATUM_TEXT_DOMAIN), $Pd50I['name'], date_i18n(get_option('date_format'), strtotime($DyFgM[$t88Br]['expires']))); goto rCdRL; h0Cxl: if (!(empty($DyFgM) || empty($DyFgM[$t88Br]) || empty($DyFgM[$t88Br]['key']))) { goto DQ5Qi; } goto blwmu; AoXZz: self::$n7E4f[] = $ARj1j; goto oLnO_; VdHPL: $dJ5t3 = sprintf(__('The ATUM %s add-on could not be loaded because is not a known add-on.', ATUM_TEXT_DOMAIN), $Pd50I['name']); goto NYmZy; TXvYE: if (!(isset($j2NLR[$U6Ff1]) || !$this->B_wWp && !empty($CjSkZ[$U6Ff1]['basename']) && file_exists(WP_PLUGIN_DIR . '/' . $CjSkZ[$U6Ff1]['basename']))) { goto MguQ2; } goto zPfXR; Q7bZb: $j2NLR[$ARj1j]['bootstrap'] = NULL; goto AoXZz; blwmu: $dJ5t3 = sprintf(__('The ATUM %1$s could not be loaded because its license is missing. Please, activate your trial from the %2$sadd-ons%3$s page.', ATUM_TEXT_DOMAIN), $Pd50I['name'], '<a href="' . add_query_arg('page', 'atum-addons', admin_url('admin.php')) . '">', '</a>'); goto HxS5Q; HxS5Q: AtumAdminNotices::add_notice($dJ5t3, strtolower($Pd50I['name']), 'error', FALSE, TRUE); goto eThyq; TQIvm: ujyRB: goto yzt8Q; CECj0: if (isset($this->hkb5Q[$U6Ff1])) { goto Bzgrr; } goto VdHPL; mQWHp: Ugq_5: goto TQIvm; KRbJL: $MXkXw[$ARj1j]['extended'] = $DyFgM[$t88Br]['extended'] ?? FALSE; goto wNESR; u1IkI: $j2NLR[$ARj1j]['bootstrap'] = NULL; goto KhqIv; Upeo8: vnYbF: goto Jtr_z; qH1Lm: if (!(empty($DyFgM[$t88Br]['expires']) || strtotime($DyFgM[$t88Br]['expires']) <= time())) { goto Ugq_5; } goto clcap; JL6vO: T2Md3: goto uK5q7; R12j7: $MXkXw[$ARj1j]['expires'] = $DyFgM[$t88Br]['expires'] ?? 'now'; goto A4Fxw; Uc59P: self::$DJCAe[] = $ARj1j; goto DlIqJ; FMqef: self::$n7E4f[] = $ARj1j; goto xPncZ; KhqIv: self::$n7E4f[] = $ARj1j; goto YoVgz; FX010: AtumAdminNotices::add_notice($dJ5t3 . ' ' . sprintf(__('Click %1$shere%2$s to purchase the full version.', ATUM_TEXT_DOMAIN), '<a href="' . $Pd50I['addon_url'] . '" target="_blank">', '</a>'), strtolower($Pd50I['name']), 'error', FALSE, TRUE); goto Q7bZb; yzt8Q: if (!(!empty($Pd50I['bootstrap']) && is_callable($Pd50I['bootstrap']))) { goto FuZHU; } goto Uc59P; v8k1H: $j2NLR[$ARj1j]['bootstrap'] = NULL; goto DASaA; pUOWf: AtumAdminNotices::add_notice($dJ5t3, strtolower($Pd50I['name']), 'error', FALSE, TRUE); goto Vpipg; erdAl: if (!(!$CppfP && !empty($this->d__e2[$ARj1j]) && version_compare($this->d__e2[$ARj1j], $Pd50I['version'], '<'))) { goto siwSj; } goto v8k1H; yr1Ts: $j2NLR[$ARj1j]['bootstrap'] = NULL; goto FQrDn; CWo3R: self::$n7E4f[] = $ARj1j; goto mIo3G; YoVgz: goto KSvZV; goto Upeo8; UavsK: $t88Br = strtolower($CjSkZ[$U6Ff1]['name'] ?? ''); goto h0Cxl; oLnO_: goto KSvZV; goto mQWHp; DlIqJ: $CppfP = call_user_func($Pd50I['bootstrap']); goto erdAl; HVcMF: $dJ5t3 = sprintf(__('The ATUM %1$s add-on requires at least version %2$s to work with the current ATUM version. Please, update it.', ATUM_TEXT_DOMAIN), $Pd50I['name'], $this->hkb5Q[$U6Ff1]); goto h14qq; DASaA: array_pop(self::$DJCAe); goto CWo3R; F_diK: FuZHU: goto KCgiY; h14qq: AtumAdminNotices::add_notice($dJ5t3, strtolower($Pd50I['name']), 'error', FALSE, TRUE); goto u1IkI; rMTxm: goto KSvZV; goto JITM_; uK5q7: $dJ5t3 = sprintf(__('Your ATUM %1$s has expired and it has been disabled.', ATUM_TEXT_DOMAIN), $Pd50I['name']); goto C99UH; wNESR: if ('now' === $MXkXw[$ARj1j]['expires']) { goto T2Md3; } goto wk19h; sh7gf: $anzkV = strpos($ARj1j, '_trial') !== FALSE || strpos($Pd50I['basename'], 'trial') !== FALSE; goto Hzbqy; k2BTJ: DQ5Qi: goto qH1Lm; C99UH: IMKXc: goto FX010; Hzbqy: $U6Ff1 = $anzkV ? str_replace('_trial', '', $ARj1j) : $ARj1j; goto CECj0; JHsRP: self::$n7E4f[] = $ARj1j; goto rMTxm; mIo3G: siwSj: goto F_diK; qVTty: } goto CNxml; yVyPf: ePQZy: goto fzX0c; h4mqC: wp_register_script('atum-trials-modal', ATUM_URL . 'assets/js/build/atum-trials-modal.js', ['jquery', 'sweetalert2'], ATUM_VERSION, TRUE); goto aewrR; C2Roq: $WOWlQ->set_js_dependencies(['atum-trials-modal']); goto iqOrF; CNxml: VbrSP: goto avOBA; ZlUxo: Addons::set_installed_addons($j2NLR); goto yVyPf; SfCkl: zdDQH: goto SerZL; iqOrF: $WOWlQ->add_modal('trial-expired', array('icon' => 'warning', 'title' => _n('ATUM trial license expired!', 'ATUM trial licenses expired!', count($MXkXw), ATUM_TEXT_DOMAIN), 'showCancelButton' => FALSE, 'showConfirmButton' => FALSE, 'customClass' => ['container' => 'atum-trial-modal'], 'footer' => sprintf(__('Why are these add-ons expired and blocked? %1$sREAD INFO%2$s', ATUM_TEXT_DOMAIN), '&nbsp;<a href="https://stockmanagementlabs.crunch.help/en/atum-core/atum-trials" target="_blank">', '</a>')), Helpers::load_view_to_string('add-ons/expired-trials-modal', ['expired_trials' => $MXkXw])); goto SfCkl; fzX0c: jcizF: goto yND3q; SerZL: if (!(count(self::$n7E4f) > 0)) { goto ePQZy; } goto ZlUxo; BVeFL: $j2NLR = Addons::get_installed_addons(); goto KV9ZI; aewrR: wp_localize_script('atum-trials-modal', 'atumTrialsModal', array('cancel' => __('Cancel', ATUM_TEXT_DOMAIN), 'extend' => __('Yes, Extend it!', ATUM_TEXT_DOMAIN), 'nonce' => wp_create_nonce(ATUM_PREFIX . 'manage_license'), 'ok' => __('OK', ATUM_TEXT_DOMAIN), 'success' => __('Success!', ATUM_TEXT_DOMAIN), 'trialExtension' => __('Trial extension', ATUM_TEXT_DOMAIN), 'trialWillExtend' => __('You are going to extend this trial for 7 days more', ATUM_TEXT_DOMAIN))); goto bfY7t; bfY7t: $WOWlQ = AtumAdminModal::get_instance([ATUM_SHORT_NAME . '-addons']); goto C2Roq; Cafir: $MXkXw = []; goto qDGvb; IWlQ7: $CjSkZ = Addons::get_addons_paths(); goto wZ1_9; KV9ZI: if (empty($j2NLR)) { goto jcizF; } goto Cafir; avOBA: if (empty($MXkXw)) { goto zdDQH; } goto h4mqC; qDGvb: $DyFgM = Addons::get_keys(); goto IWlQ7; yND3q: } public function check_trials() { add_filter('atum/queues/recurring_hooks', function ($Ry6vZ) { $Ry6vZ['atum/check_trials'] = array('time' => 'now', 'interval' => DAY_IN_SECONDS); return $Ry6vZ; }); add_action('atum/check_trials', function () { goto Q1V1T; Kajis: foreach ($j1v2N as $RQT2g) { goto KX3im; bxYH_: if (!(empty($pHLfb['trial']) && isset($bJFHl->zOO4d) && TRUE === $bJFHl->zOO4d)) { goto NxejR; } goto m9pd0; ub79_: aSF1b: goto gqI5Q; HGX47: $bJFHl = json_decode(wp_remote_retrieve_body($sv86u)); goto tbWQz; W1M6Z: C1QlU: goto kqcdy; PtB7P: jXpZO: goto MaeBv; m9pd0: $azQ1q['trial'] = TRUE; goto NTLz5; k_sDZ: if (!(empty($pHLfb['extended']) && (!isset($bJFHl->HEu9Q) || TRUE !== $bJFHl->HEu9Q))) { goto jXpZO; } goto ut3j7; H1jyu: r6Sla: goto bxYH_; wWW_w: TmCcw: goto AFB0O; GUifQ: $t88Br = trim(str_replace('trial', '', $umBc3)); goto L015n; HPzG0: A4VnP: goto NYOmf; Q8zBC: if (!(strpos($umBc3, 'trial') !== FALSE)) { goto zshoq; } goto GUifQ; B52z8: $azQ1q['status'] = $bJFHl->ISeJX; goto ub79_; FtcDe: if (!(!is_wp_error($sv86u) && isset($pHLfb['status']) && 'valid' === $pHLfb['status'])) { goto A4VnP; } goto HGX47; Z05cb: Addons::update_key($umBc3, $azQ1q); goto W1M6Z; L015n: if (!array_key_exists($vQn0P[$t88Br])) { goto VUuOl; } goto SeIyI; gqI5Q: if (!(empty($pHLfb['expires']) || $pHLfb['expires'] !== $bJFHl->p9dEz)) { goto r6Sla; } goto nNmaf; ut3j7: $azQ1q['extended'] = TRUE; goto PtB7P; nNmaf: $azQ1q['expires'] = $bJFHl->p9dEz ?? date_i18n('Y-m-d H:i:s'); goto H1jyu; tbWQz: $azQ1q = $pHLfb; goto REJca; NTLz5: NxejR: goto k_sDZ; MaeBv: if (empty(array_diff_assoc($pHLfb, $azQ1q))) { goto C1QlU; } goto Z05cb; REJca: if (!$bJFHl) { goto qzQLa; } goto ecQQf; Cqd4h: zshoq: goto wWW_w; SeIyI: $pHLfb = $vQn0P[$t88Br]; goto qB5A5; qB5A5: $sv86u = Addons::check_license($umBc3, $pHLfb['key']); goto FtcDe; KX3im: $umBc3 = strtolower($RQT2g['name']); goto Q8zBC; NYOmf: VUuOl: goto Cqd4h; ecQQf: if (!($pHLfb['status'] !== $bJFHl->ISeJX)) { goto aSF1b; } goto B52z8; kqcdy: qzQLa: goto HPzG0; AFB0O: } goto OIDsh; Q1V1T: $vQn0P = Addons::get_keys(); goto OpbSK; OIDsh: nwBP4: goto ysAgT; OpbSK: $j1v2N = Addons::get_installed_addons(); goto Kajis; ysAgT: }); } public static function get_bootstrapped_addons() { return self::$DJCAe; } public static function get_non_bootstrapped_addons() { return self::$n7E4f; } public static function check_addon($LEdLv, $umBc3, $EvB3C) { goto oIWxG; oIWxG: if (!(stripos($LEdLv, '_trial') === FALSE)) { goto tYtwG; } goto uj0k9; uj0k9: return FALSE; goto JCQKo; FREIA: return FALSE; goto vT6rU; w6g1V: if (!(stripos($EvB3C, '-trial.php') === FALSE)) { goto r9BSj; } goto FREIA; JvMv4: if (!(stripos($umBc3, 'Trial') === FALSE)) { goto i7ewG; } goto z3JVE; JCQKo: tYtwG: goto JvMv4; o1E5x: return TRUE; goto u03li; z3JVE: return FALSE; goto qKh9Z; qKh9Z: i7ewG: goto w6g1V; vT6rU: r9BSj: goto o1E5x; u03li: } }