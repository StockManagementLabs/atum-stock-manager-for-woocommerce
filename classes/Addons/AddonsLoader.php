<?php
/** @noinspection ALL */
/**
  * @author      Be Rebel - https://berebel.io
  * @copyright   ©2023 Stock Management Labs™
 */
 namespace Atum\Addons; defined('ABSPATH') || die; use Atum\Components\AtumAdminNotices; use Atum\Components\AtumAdminModal; use Atum\Inc\Helpers; final class AddonsLoader { private $TUrHr = array('action_logs' => '1.1.5', 'export_pro' => '1.3.4', 'multi_inventory' => '1.5.0', 'product_levels' => '1.6.0', 'purchase_orders' => '0.0.1', 'stock_takes' => '0.0.1', 'pick_pack' => '0.0.1'); private $NL7kS = array('action_logs' => '1.3.5', 'export_pro' => '1.5.5', 'multi_inventory' => '1.8.0', 'product_levels' => '1.8.7.1', 'purchase_orders' => '1.1.1', 'stock_takes' => '1.0.0', 'pick_pack' => '1.0.0'); private static $pNnXw = []; private static $yQk99 = []; private $Nwe_W; public function __construct() { goto aIqsb; aIqsb: $this->Nwe_W = defined('ATUM_DEBUG') && TRUE === ATUM_DEBUG; goto jyqvb; Moys6: $this->check_trials(); goto hdfP3; jyqvb: add_action('after_setup_theme', array($this, 'load_addons'), 99); goto Moys6; hdfP3: } public function load_addons() { goto Oef_a; Oef_a: $CbhwB = Addons::get_installed_addons(); goto yz6vC; awvFe: Addons::set_installed_addons($CbhwB); goto OJYX5; AXt2h: $EbEFP->add_modal('trial-expired', array('cancel' => __('Cancel', ATUM_TEXT_DOMAIN), 'customClass' => ['container' => 'atum-trial-modal'], 'extend' => __('Yes, Extend it!', ATUM_TEXT_DOMAIN), 'footer' => sprintf(__('Why are these add-ons expired and blocked? %1$sREAD INFO%2$s', ATUM_TEXT_DOMAIN), '&nbsp;<a href="https://stockmanagementlabs.crunch.help/en/atum-core/atum-trials" target="_blank">', '</a>'), 'icon' => 'warning', 'nonce' => wp_create_nonce(ATUM_PREFIX . 'manage_license'), 'ok' => __('OK', ATUM_TEXT_DOMAIN), 'showCancelButton' => FALSE, 'showConfirmButton' => FALSE, 'success' => __('Success!', ATUM_TEXT_DOMAIN), 'title' => _n('ATUM trial license expired!', 'ATUM trial licenses expired!', count($rXplF), ATUM_TEXT_DOMAIN), 'trialExtension' => __('Trial extension', ATUM_TEXT_DOMAIN), 'trialWillExtend' => __('You are going to extend this trial for 7 days more', ATUM_TEXT_DOMAIN)), Helpers::load_view_to_string('add-ons/expired-trials-modal', ['expired_trials' => $rXplF])); goto oHV4j; cgucY: w__FA: goto CWjLo; BpRNg: $POCji = Addons::get_keys(); goto WGFRi; WGFRi: $qYHrA = Addons::get_addons_paths(); goto LOtW2; oHV4j: DDRQf: goto BmAM8; yz6vC: if (empty($CbhwB)) { goto w__FA; } goto SoY1o; sgCkN: $EbEFP = AtumAdminModal::get_instance([ATUM_SHORT_NAME . '-addons']); goto AXt2h; OJYX5: GR1OZ: goto cgucY; SN15G: qgEpK: goto s3mbj; BmAM8: if (!(count(self::$yQk99) > 0)) { goto GR1OZ; } goto awvFe; s3mbj: if (empty($rXplF)) { goto DDRQf; } goto sgCkN; LOtW2: foreach ($CbhwB as $qOQXO => $ms2lD) { goto KGs_a; Nslbu: $CbhwB[$qOQXO]['bootstrap'] = NULL; goto cHf9f; yBwtc: goto a8z1O; goto UWSJL; r1564: X0Atw: goto yOlPf; JPskH: if ('now' === $rXplF[$qOQXO]['expires']) { goto wVwwO; } goto HWvoI; eyAwf: $rXplF[$qOQXO]['key'] = $POCji[$hQLTe]['key']; goto DiqbA; S41oB: self::$pNnXw[] = $qOQXO; goto fplma; Vay2m: $CbhwB[$qOQXO]['bootstrap'] = NULL; goto dQCfp; F5ual: self::$yQk99[] = $qOQXO; goto volCR; EKkNx: hVqDq: goto r1564; x8ZEn: if (!(empty($POCji) || empty($POCji[$hQLTe]) || empty($POCji[$hQLTe]['key']))) { goto tP2_V; } goto PEU9u; UkCfL: AtumAdminNotices::add_notice($c4y15, strtolower($ms2lD['name']), 'error', FALSE, TRUE); goto jIepU; dQCfp: array_pop(self::$pNnXw); goto QJk5v; YRp4L: $CbhwB[$qOQXO]['bootstrap'] = NULL; goto F5ual; fplma: $WmTgV = call_user_func($ms2lD['bootstrap']); goto R5soo; cHf9f: self::$yQk99[] = $qOQXO; goto hYCRR; jIepU: $CbhwB[$qOQXO]['bootstrap'] = NULL; goto i9fdY; volCR: goto a8z1O; goto U4EMZ; VmtH_: AtumAdminNotices::add_notice($c4y15 . ' ' . sprintf(__('Click %1$shere%2$s to purchase the full version.', ATUM_TEXT_DOMAIN), '<a href="' . $ms2lD['addon_url'] . '" target="_blank">', '</a>'), strtolower($ms2lD['name']), 'error', FALSE, TRUE); goto YRp4L; yOlPf: a8z1O: goto cs1yn; GWP8o: goto a8z1O; goto tMk0L; HWvoI: $c4y15 = sprintf(__('Your ATUM %1$s has expired on %2$s, and it has been disabled.', ATUM_TEXT_DOMAIN), $ms2lD['name'], date_i18n(get_option('date_format'), strtotime($POCji[$hQLTe]['expires']))); goto rioLu; UWSJL: eFfpP: goto s3wG0; Gf7G3: qioId: goto q7oWI; Dl5sB: $c4y15 = sprintf(__('The ATUM %s add-on could not be loaded because is not a known add-on.', ATUM_TEXT_DOMAIN), $ms2lD['name']); goto i52QP; WBIVu: $f7FNI = $dnRp2 ? str_replace('_trial', '', $qOQXO) : $qOQXO; goto rjUFM; q7oWI: if (!$dnRp2) { goto D1T16; } goto DmL0w; Q4yLF: self::$yQk99[] = $qOQXO; goto yBwtc; KVkbt: AtumAdminNotices::add_notice($c4y15, strtolower($ms2lD['name']), 'error', FALSE, TRUE); goto Nslbu; O3jjy: wVwwO: goto nUfR3; yUts9: if (!(!empty($ms2lD['bootstrap']) && is_callable($ms2lD['bootstrap']))) { goto X0Atw; } goto S41oB; s3wG0: if (!version_compare($this->NL7kS[$f7FNI], $ms2lD['version'], '>')) { goto qioId; } goto jlD_T; QbgAL: t7L5f: goto VmtH_; GC5CB: $CbhwB[$qOQXO]['bootstrap'] = NULL; goto Q4yLF; i52QP: AtumAdminNotices::add_notice($c4y15, strtolower($ms2lD['name']), 'error', FALSE, TRUE); goto GC5CB; jlD_T: $c4y15 = sprintf(__('The ATUM %1$s add-on requires at least version %2$s to work with the current ATUM version. Please, update it.', ATUM_TEXT_DOMAIN), $ms2lD['name'], $this->NL7kS[$f7FNI]); goto UkCfL; yBkd_: $CbhwB[$qOQXO]['bootstrap'] = NULL; goto t_QTt; SKuEA: $c4y15 = sprintf(__('The ATUM %s could not be loaded because the full version is installed. To use the trial, uninstall the full version first.', ATUM_TEXT_DOMAIN), $ms2lD['name']); goto CzYls; DiqbA: $rXplF[$qOQXO]['extended'] = $POCji[$hQLTe]['extended'] ?? FALSE; goto JPskH; qARzD: D1T16: goto yUts9; hYCRR: goto a8z1O; goto Gy0hi; Gy0hi: tP2_V: goto g2rup; U4EMZ: Bk6qD: goto qARzD; HBce7: $rXplF[$qOQXO] = $ms2lD; goto Xw_B7; R5soo: if (!(!$WmTgV && !empty($this->TUrHr[$qOQXO]) && version_compare($this->TUrHr[$qOQXO], $ms2lD['version'], '<'))) { goto hVqDq; } goto Vay2m; Xw_B7: $rXplF[$qOQXO]['expires'] = $POCji[$hQLTe]['expires'] ?? 'now'; goto eyAwf; t_QTt: self::$yQk99[] = $qOQXO; goto GWP8o; i9fdY: self::$yQk99[] = $qOQXO; goto dyS_s; g2rup: if (!(empty($POCji[$hQLTe]['expires']) || strtotime($POCji[$hQLTe]['expires']) <= time())) { goto Bk6qD; } goto HBce7; dyS_s: goto a8z1O; goto Gf7G3; QJk5v: self::$yQk99[] = $qOQXO; goto EKkNx; DmL0w: if (!(isset($CbhwB[$f7FNI]) || !$this->Nwe_W && !empty($qYHrA[$f7FNI]['basename']) && file_exists(WP_PLUGIN_DIR . '/' . $qYHrA[$f7FNI]['basename']))) { goto jn_gW; } goto SKuEA; iE9_X: $hQLTe = strtolower($qYHrA[$f7FNI]['name'] ?? ''); goto x8ZEn; tMk0L: jn_gW: goto iE9_X; PEU9u: $c4y15 = sprintf(__('The ATUM %1$s could not be loaded because its license is missing. Please, activate your trial from the %2$sadd-ons%3$s page.', ATUM_TEXT_DOMAIN), $ms2lD['name'], '<a href="' . add_query_arg('page', 'atum-addons', admin_url('admin.php')) . '">', '</a>'); goto KVkbt; CzYls: AtumAdminNotices::add_notice($c4y15, strtolower($ms2lD['name']), 'error', FALSE, TRUE); goto yBkd_; nUfR3: $c4y15 = sprintf(__('Your ATUM %1$s has expired and it has been disabled.', ATUM_TEXT_DOMAIN), $ms2lD['name']); goto QbgAL; rioLu: goto t7L5f; goto O3jjy; KGs_a: $dnRp2 = strpos($qOQXO, '_trial') !== FALSE || strpos($ms2lD['basename'], 'trial') !== FALSE; goto WBIVu; rjUFM: if (isset($this->NL7kS[$f7FNI])) { goto eFfpP; } goto Dl5sB; cs1yn: } goto SN15G; SoY1o: $rXplF = []; goto BpRNg; CWjLo: } public function check_trials() { add_filter('atum/queues/recurring_hooks', function ($n7syo) { $n7syo['atum/check_trials'] = array('time' => 'now', 'interval' => DAY_IN_SECONDS); return $n7syo; }); add_action('atum/check_trials', function () { goto WvQUR; KY0LM: foreach ($jpcsF as $Oe0Nt => $U4c7H) { goto agZx2; YT1zX: if (!($U4c7H['status'] !== $G6H9T->rK1XZ)) { goto C29qA; } goto kk1Xj; pg6NU: if (!(empty($U4c7H['extended']) && (!isset($G6H9T->Oa0hQ) || TRUE !== $G6H9T->Oa0hQ))) { goto dlSv0; } goto V5iZc; ZDbJA: V883Z: goto RJ30L; PFaDZ: if (!(!is_wp_error($akd7s) && isset($U4c7H['status']) && 'valid' === $U4c7H['status'])) { goto Z1Hc3; } goto Enz7e; HtX8k: $akd7s = Addons::check_license($Oe0Nt, $U4c7H['key']); goto PFaDZ; Enz7e: $G6H9T = json_decode(wp_remote_retrieve_body($akd7s)); goto zqkyF; jueN_: dlSv0: goto WVbz0; WDZ4K: Z1Hc3: goto oDfKP; oDfKP: p4AY4: goto ZDbJA; WVbz0: K0rjv: goto e2I00; e2I00: if (empty($YV3_2)) { goto QFKvS; } goto m7DHR; QVVzj: $YV3_2['expires'] = $G6H9T->sGjjj; goto t39rN; QJZPR: if (!$G6H9T) { goto K0rjv; } goto YT1zX; m7DHR: $YV3_2['key'] = $U4c7H['key']; goto v1zmO; agZx2: if (!(!empty($U4c7H['trial']) && TRUE === $U4c7H['trial'])) { goto p4AY4; } goto HtX8k; HosVv: C29qA: goto V6a6O; kk1Xj: $YV3_2['status'] = $G6H9T->rK1XZ; goto HosVv; v1zmO: Addons::update_key($Oe0Nt, $YV3_2); goto H7OO7; zqkyF: $YV3_2 = []; goto QJZPR; t39rN: sCxQX: goto pg6NU; H7OO7: QFKvS: goto WDZ4K; V6a6O: if (!(empty($U4c7H['expires']) || $U4c7H['expires'] !== $G6H9T->sGjjj)) { goto sCxQX; } goto QVVzj; V5iZc: $YV3_2['extended'] = TRUE; goto jueN_; RJ30L: } goto sBbMd; WvQUR: $jpcsF = Addons::get_keys(); goto KY0LM; sBbMd: e48Vf: goto TmRG9; TmRG9: }); } public static function get_bootstrapped_addons() { return self::$pNnXw; } public static function get_non_bootstrapped_addons() { return self::$yQk99; } }